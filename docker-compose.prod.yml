version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: catxi-nginx
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Nginx 설정 파일
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Let's Encrypt 인증서
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
      # 로그
      - ./nginx/logs:/var/log/nginx

    depends_on:
      app:
        condition: service_healthy

    networks:
      - catxi-network

    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Let's Encrypt Certbot
  certbot:
    image: certbot/certbot
    container_name: catxi-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # 인증서 자동 갱신 (12시간마다 체크)
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

    networks:
      - catxi-network

  # Spring Boot Application
  app:
    image: ${AWS_ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/catxi-backend:${BUILD_NUMBER:-latest}
    container_name: catxi-app
    restart: unless-stopped

    # 내부 네트워크에서만 접근 (Nginx를 통해서만 외부 접근)
    expose:
      - "8080"

    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - TZ=Asia/Seoul

    env_file:
      - .env

    volumes:
      # Application logs
      - ./logs:/app/logs
      # Firebase service account (read-only)
      - ./firebase-service-account.json:/app/config/firebase-service-account.json:ro

    depends_on:
      redis:
        condition: service_healthy

    networks:
      - catxi-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

    # Resource limits (adjust based on EC2 instance size)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: catxi-redis
    restart: unless-stopped

    # Redis password from .env file
    command: >
      sh -c "redis-server
      --requirepass $${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --maxmemory 128mb
      --maxmemory-policy allkeys-lru"

    environment:
      - TZ=Asia/Seoul

    env_file:
      - .env

    volumes:
      # Persistent storage for Redis data
      - redis-data:/data

    networks:
      - catxi-network

    healthcheck:
      test: ["CMD", "sh", "-c", "redis-cli -a $${REDIS_PASSWORD} ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

volumes:
  redis-data:
    driver: local

networks:
  catxi-network:
    driver: bridge
